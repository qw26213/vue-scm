<script src="static/js/plugins/jquery.dataTables.min.js"></script>
<style>
.table>thead>tr>th {text-align: center;}
</style>

<div class="bw100 urel">
    <div class="plr15 ov-y bgb pb15" style="height:100%;">
        <div class="clearfix mt10">
            <form id="searchForm" class="clearfix urel search-content" style="width:1080px">
				<input id="PDF" name="PDF" type="hidden" value="0"/>
                <div class="form-group uds">
                    <div class="form-group uds">
	                    <label class="uds">统计日期:</label>
	                    <div class="input-group date uds urel">
	                        <input type="text" class="form-control w120 h28 dataTime1" name="jeDate1" id="jeDate1" readonly>
	                        <div class="date_icon" onclick="showDate(this)"></div>
	                    </div>
	                    <span>至</span>
	                    <div class="input-group date uds urel">
	                        <input type="text" class="form-control w120 h28 dataTime2" name="jeDate2" id="jeDate2" readonly>
		                    <div class="date_icon" onclick="showDate(this)"></div>
	                    </div>
	                    <label class="ml10">&nbsp;&nbsp;&nbsp;&nbsp;显示合计:</label>
    	                <input class="uds mt0 ml05" id="rollUp" name="rollUp" type="checkbox" checked value="1"/>
	                    <label class="ml10">&nbsp;&nbsp;&nbsp;&nbsp;显示辅助项代码:</label>
    	                <input class="uds mt0 ml05" id="dispCode" name="dispCode" type="checkbox" value="1"/>
   	    	            <label class="ml10">&nbsp;&nbsp;&nbsp;&nbsp;横向打印:</label>
	    	            <input class="uds mt0 ml05" id="rotate" name="rotate" checked type="checkbox" value="1"/>
						&nbsp;&nbsp;&nbsp;&nbsp;
	    	            <button type="button" class="btn btn-wrap plr20 ufr"  onclick="exportExcel()">导出</button>	    	            	    	            	    	            
	    	            <button type="button" class="btn btn-wrap plr20 ufr"  onclick="printChart()">打印</button>
	    	            <button type="button" class="btn btn-search plr20 ufr"  onclick="queryGrossProfit()">查询</button>    	                
                    </div>
	                <br />
                    <div class="form-group uds" id="showGroupType">
                     		<label class="uds">一级汇总:</label>
           					<input type="radio" class="uinline-block mr05" id="day" name="group_type" onchange="typeChanged(this)" value="day" checked="checked"/>按年-月-日
           					<input type="radio" class="uinline-block mr05" id="week" name="group_type" onchange="typeChanged(this)" value="week" />按年-周
           					<input type="radio" class="uinline-block mr05" id="tendays" name="group_type" onchange="typeChanged(this)" value="tendays" />按年-月-旬
           					<input type="radio" class="uinline-block mr05" id="month" name="group_type" onchange="typeChanged(this)" value="month" />按年-月
           					<input type="radio" class="uinline-block mr05" id="quarter" name="group_type" onchange="typeChanged(this)" value="quarter" />按年-季
            				<input type="radio" class="uinline-block mr05" id="type" name="group_type" onchange="typeChanged(this)" value="type" />只按二级汇总
                    </div>
	                <br />
                    <div class="form-group uds" id="showType">
                     		<label class="uds">二级汇总:</label>
           					<input type="radio" class="uinline-block mr05" id="dept" name="type" value="dept" checked="checked" />网点
           					<input type="radio" class="uinline-block mr05" id="staff" name="type"  value="staff" />销售员
           					<input type="radio" class="uinline-block mr05" id="item" name="type" value="item" />产品
           					<input type="radio" class="uinline-block mr05" id="inv" name="type"  value="inv" />品类
           					<input type="radio" class="uinline-block mr05" id="dept_inv" name="type" value="dept_inv" />网点-品类
           					<input type="radio" class="uinline-block mr05" id="dept_item" name="type" value="dept_item" />网点-产品
           					<input type="radio" class="uinline-block mr05" id="dept_staff" name="type" value="dept_staff" />网点-销售员
           					<input type="radio" class="uinline-block mr05" id="item_staff" name="type" value="item_staff" />产品-销售员
           					<input type="radio" class="uinline-block mr05" id="staff_inv" name="type" value="staff_inv" />销售员-品类
            				<input type="radio" class="uinline-block mr05" id="date" name="type" value="date" />只按一级汇总
                    </div>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                   	<label class="uds">品类级次:</label>
	                <select id="invCatgLevel" class="form-control w60 h28 uds p0" name="invCatgLevel" onchange="initDataTables2()">
                        <option value="1" selected>一级</option>
                        <option value="2">二级</option>
                        <option value="3">三级</option>
                        <option value="4">四级</option>
                        <option value="5">五级</option>
                        <option value="">末级</option>
                    </select>
	                <i class="red" onclick="alertInfo('选择一至五级只统计产品所属本级的数据,选择末级统计产品所属最末品级的数据。')">!</i>
                </div>
                <style>.uhideM {display: none!important;}</style>   
            </form>
        </div>         
	    <table id="dataTable" class="table table-striped table-bordered printThis" cellspacing="0" width="100%">
	     	<thead>
    	 	</thead>
	    </table>
    </div>
</div>
<script  type="text/javascript">
var dataTable;
initDatepicker('#jeDate1',-1);
initDatepicker('#jeDate2',-1);
queryGrossProfit();
function typeChanged() {
	var radioGroupType = document.getElementsByName("group_type");
	for(var i = 0;i<radioGroupType.length;i++){
		if(radioGroupType[i].checked==true){
			valueGroupType = radioGroupType[i].value;
			break;
		}
	}
	if('type'==valueGroupType){
		var radioType = document.getElementsByName("type");
		for(var i = 0;i<radioType.length;i++){
			if(radioType[i].checked==true){
				valueType = radioType[i].value;
				break;
			}
		}
		if('date'==valueType){
		    $("#dept").prop("checked",true);
		}
	    $("#date").attr("disabled",true);
	}else{
	    $("#date").attr("disabled",false);
	}
}

function queryGrossProfit() {
    var searchData = $("#searchForm").formToObj();
    if (dataTable) {  
        dataTable.fnClearTable();    //清空数据
        dataTable.fnDestroy();         //销毁
    } 
    var selectTypeValue = $('#showType input:checked').val();
    var selectGroupTypeValue = $('#showGroupType input:checked').val();
    dataTable = $("#dataTable").dataTable({
        bSort: !$('input[name=rollUp]').is(':checked'), //是否启动各个字段的排序功能
        bFilter: false, //是否启动过滤、搜索功能
        lengthChange: false, //是否允许用户自定义每页显示数量
        iDisplayLength: 50, //默认显示的记录数
        oLanguage: {
            sProcessing: "正在获取数据，请稍后...",
            sZeroRecords: "无数据!",
            sInfo : "共 _TOTAL_ 条",
            sInfoEmpty: "记录数为0",
            oPaginate: {
                "sFirst": "第一页",
                "sPrevious": "上一页",
                "sNext": "下一页",
                "sLast": "最后一页"
            }
        },
        sAjaxSource: ip_url+"gp/grossprofit/queryGrossProfit",
        fnServerData: function(sSource, aDataSet, fnCallback) {
            var searchData = $("#searchForm").formToObj();
            $.ajax({
                "dataType": 'json',
                "contentType": "application/json",
                "type": "POST",
                "url": sSource,
                "async": false,
                "data": JSON.stringify(searchData),
                "success": fnCallback,
                "error": function(e) {
                    layer.alert("系统错误");
                }
            });
        },
        aoColumns: [{
            "mData": "groupBy",
            'sClass':'tx-c',
            "bSortable":true,
            'bVisible':selectGroupTypeValue.indexOf('type')<0,
            "sTitle": "分类",
            "mRender": function(data, type, full) {
            	if(data==null||data==''||data.length<4){
            		data='合计';
            	}else if(selectGroupTypeValue=="week"){
            		data=data.substr(0,4)+'年'+data.substr(4,2)+'周';
            	}else if(selectGroupTypeValue=="tenday"){
            		var t=data.substr(6,1);
            		if(t=='1')
            			tt='上';
            		else if(t=='2')
                			tt='中';
                		else
                			tt='下';
            		data=data.substr(0,4)+'年'+data.substr(4,2)+'月'+tt+'旬';
            	}else if(selectGroupTypeValue=="month"){
            		data=data.substr(0,4)+'年'+data.substr(4,2)+'月';
            	}else if(selectGroupTypeValue=="quarter"){
            		data=data.substr(0,4)+'年'+data.substr(4,1)+'季';
            	}
            	return data;
            }
        }, {
            "mData": "deptCode",
            'sClass':'tx-c',
            'bVisible':selectTypeValue.indexOf('dept')>=0 && $('input[name=dispCode]').is(':checked'),
            "sTitle": "网点代码"
        }, {
            "mData": "deptName",
            'sClass':'tx-c',
            'bVisible':selectTypeValue.indexOf('dept')>=0,
            "sTitle": "网点名称"
        }, {
            "mData": "itemCode",
            'sClass':'tx-c',
            'bVisible':selectTypeValue.indexOf('item')>=0 && $('input[name=dispCode]').is(':checked'),
            "sTitle": "产品代码"
        }, {
            "mData": "itemName",
            'sClass':'tx-c',
            'bVisible':selectTypeValue.indexOf('item')>=0,
            "sTitle": "产品名称"
        }, {
            "mData": "staffCode",
            'sClass':'tx-c',
            'bVisible':selectTypeValue.indexOf('staff')>=0 && $('input[name=dispCode]').is(':checked'),
            "sTitle": "销售员代码"
        }, {
            "mData": "staffName",
            'sClass':'tx-c',
            'bVisible':selectTypeValue.indexOf('staff')>=0,
            "sTitle": "销售员名称"
        }, {
            "mData": "invCatgCode",
            'sClass':'tx-c',
            'bVisible':selectTypeValue.indexOf('inv')>=0 && $('input[name=dispCode]').is(':checked'),
            "sTitle": "品类代码"
        }, {
            "mData": "invCatgName",
            'sClass':'tx-c',
            'bVisible':selectTypeValue.indexOf('inv')>=0,
            "sTitle": "品类名称"
        }, {
            "mData": "income",
            "sTitle": "收入",
            'sClass':'tx-c',
            "bSortable":true,
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "cost",
            "sTitle": "成本",
            'sClass':'tx-c',
            "bSortable":true,
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "incomeNum",
            "sTitle": "销售数量",
            'sClass':'tx-c',
            "bSortable":true,
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "costNum",
            "sTitle": "采购数量",
            'sClass':'tx-c',
            "bSortable":true,
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "incomePrice",
            "sTitle": "销售平均价",
            'sClass':'tx-c',
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 4, true, true));
            }
        }, {
            "mData": "costPrice",
            "sTitle": "采购平均价",
            'sClass':'tx-c',
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 4, true, true));
            }
        }, {
            "mData": "grossProfit",
            "sTitle": "毛利",
            'sClass':'tx-c',
            "bSortable":true,
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "grossProfitMargin",
            "sTitle": "毛利率(%)",
            'sClass':'tx-c',
            "bSortable":true,
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }],
        fnDrawCallback: function(oSettings) {
            $('#' + oSettings.sTableId).css("width", "100%");
        }
    });
}
function printChart(){
    var data = $("#searchForm").formToObj();
    var exportUrl=ip_url+"gp/grossprofit/printGrossProfit2";
    $.ajax({
        url: exportUrl,
        dataType: "json",
        data: JSON.stringify(data),
        type: "post",
        async: true,
        contentType: "application/json; charset=utf-8",
        success: function(res) {
            if (res.errorCode=="0") {
                window.open("http://"+window.location.host+res.body);
            } else {
                layer.msg(res.msg,{icon:5});
            }
        },
        error: function(e) {
        	 layer.alert("系统错误!");
        }
    });
}

function exportExcel() {
    var data = $("#searchForm").formToObj();
    var exportUrl=ip_url+"gp/grossprofit/exportGrossProfit2";
    var temp = document.createElement("form");
    temp.action = exportUrl;
    temp.method = "POST";
    // temp.target = "_blank";
    temp.style.display = 'none';
    for (var x in data) {
        var opt = document.createElement("textarea");
        opt.name = x;
        opt.value = data[x];
        temp.appendChild(opt);
    }
    document.body.appendChild(temp);
    temp.submit();
    return temp;
}

</script>
