<div class="bw100 urel" style="padding-bottom:0">
    <div class="plr15 ov-y bgb pb15" style="height:100%;">
        <div class="clearfix mt10">
            <form id="searchForm" class="clearfix urel search-content" style="width:1024px">
                <div class="form-group uds">
                    <label>会计期间:</label>
                    <select id="periodCode1" name="periodCode1" class="form-control w120 h28 p0 uds"></select>
                    <span>至</span>
                    <select id="periodCode2" name="periodCode2" class="form-control w120 h28 p0 uds"></select>
                    <label style="margin-left:16px">科目:</label>
                    <input type="hidden" name="coaCode1" value="1001">
                    <input id="coaCode1" type="text" placeholder="开始科目" class="form-control w140 h28 uds" readonly onclick="openLayer(1)">
                    <span>至</span>
	                <input id="coaCode2" placeholder="结束科目" class="form-control w140 h28 uds" readonly onclick="openLayer(2)" />
                    
                   	&nbsp;&nbsp;&nbsp;&nbsp;
	                <button type="button" class="btn btn-wrap plr20 ufr"  onclick="exportExcel()">导出</button>	    	            	    	            	    	            
		    	    <button type="button" class="btn btn-wrap plr20 ufr"  onclick="printChart()">打印</button>
		    	    <button type="button" class="btn btn-search plr20 ufr"  onclick="reGetDataTables()">查询</button>			       		                                        
                </div>
                <div class="form-group uhide">
                    <label style="width:50px">币别:</label>
                    <select id="currency" name="currency" class="form-control w80 h28 p0 uds"></select>
                </div>
                <div class="form-group uds">
                    <label>科目级次:</label>
                    <select id="coaLevel1" name="coaLevel1" class="form-control w40 h28 p0 uds" onchange="coalevelChange(this.value)">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                        <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                    </select>
                    <span>至</span>
                    <select id="coaLevel2" name="coaLevel2" class="form-control w40 h28 p0 uds">
                        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                        <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                    </select>
                    <label>数量小数位数:</label>
                    <select id="numScale" class="form-control w40 h28 p0 uds" name="numScale">
                        <option value="0">0</option><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option>
                    </select>
                    <label class="ml20">单价小数位数:</label>
                    <select id="priceScale" class="form-control w40 h28 p0 uds" name="priceScale">
                        <option value="0">0</option><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option><option value="4">4</option>
                    </select>
                    <input style="margin-left:16px" name="isShowAuxiliary" type="checkbox" value="1"><span class="uds">显示辅助核算</span>
                    <input name="isQuantity" type="checkbox" value="1" checked class="ml20" /><span class="uds">只显示数量核算科目</span>
                    <input name="isShowNetAndBalanceNotEqualToZero" type="checkbox" value="1"class="ml20" /><span class="uds">发生额为0且余额为0不显示</span>
                </div>
            </form>
        </div>
        <table id="dataTable" class="table table-striped table-bordered printThis" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th class="tx-c" rowspan="2">科目编码</th>
                    <th class="tx-c" rowspan="2">科目名称</th>
                    <th class="tx-c" rowspan="2">单位</th>
                    <th class="tx-c" colspan="4">期初余额</th>
                    <th class="tx-c" colspan="2">本期借方</th>
                    <th class="tx-c" colspan="2">本期贷方</th>
                    <th class="tx-c" colspan="2">本年借方</th>
                    <th class="tx-c" colspan="2">本年贷方</th>
                    <th class="tx-c" colspan="4">期末余额</th>
                </tr>
                <tr>
                    <th class="tx-c">方向</th><th class="tx-c">数量</th><th class="tx-c">单价</th><th class="tx-c">金额</th>
                    <th class="tx-c">数量</th><th class="tx-c">金额</th><th class="tx-c">数量</th><th class="tx-c">金额</th>
                    <th class="tx-c">数量</th><th class="tx-c">金额</th><th class="tx-c">数量</th><th class="tx-c">金额</th>
                    <th class="tx-c">方向</th><th class="tx-c">数量</th><th class="tx-c">单价</th><th class="tx-c">余额</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
<!-- 科目树 -->
<div class="modal uhide" id="myModal" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog w300">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">关闭</button>
                <h4 class="modal-title" id="summaryModalLabel">请选择科目</h4>
            </div>
            <div class="modal-body clearfix p10">
                <div class="w300 plr15 ufl">
                    <div id="glCoaTree" class="ztree h400 ov-y">
                        正在初始化化科目树...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
var dataTable;
initCurrencyList('currency');
getVoucherDate();
dropmenuToggle();
function getVoucherDate() {
    $.ajax({
        url: ip_url+"gl/period/getSelectList",
        dataType: "json",
        type: "post",
        async: true,
        contentType: "application/json; charset=utf-8",
        success: function(res) {
            coursePeriod = res.data;
            initCoaPeriod('periodCode1',res.data);initCoaPeriod('periodCode2',res.data);initDataTables();
        },
        error : function(e) {
            logout_login("请重新登录");
        }
    });
}

function initDataTables() {
    var numberScale = $('#numScale').val();
    var priceScale = $('#priceScale').val();
    dataTable = $("#dataTable").dataTable({
        bSort: false, //是否启动各个字段的排序功能
        bFilter: false, //是否启动过滤、搜索功能
        lengthChange: false, //是否允许用户自定义显示数量
        iDisplayLength: 15, //默认显示的记录数
        oLanguage: {
            sProcessing: "正在获取数据，请稍后...",
            sZeroRecords: "无数据!",
            sInfo : "共 _TOTAL_ 条",
            sInfoEmpty: "记录数为0",
            oPaginate: {
                "sFirst": "第一页",
                "sPrevious": "上一页",
                "sNext": "下一页",
                "sLast": "最后一页"
            }
        },
        sAjaxSource: "accbook/ledgernum/datatables",
        fnServerData: function(sSource, aDataSet, fnCallback) {
            var searchData = $("#searchForm").formToObj();

            $.ajax({
                "dataType": 'json',
                "contentType": "application/json",
                "type": "POST",
                "url": sSource,
                "async": false,
                "data": JSON.stringify(searchData),
                "success": fnCallback,
                error : function(e) {
                    logout_login("请重新登录");
                }
            });
        },
        aoColumns: [{
            "mData": "coaCode",
            "sTitle": "科目编码"
        }, {
            "mData": "pageCoaName",
            "sTitle": "科目名称",
        }, {
            "mData": "uom",
            "sTitle": "单位"
        }, {
            "mData": "crDrStr",
            "sTitle": "方向",
        }, {
            "mData": "beginNum",
            "sTitle": "数量",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, numberScale, true, true));
            }
        }, {
            "mData": "beginUnitPrice",
            "sTitle": "单价",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, priceScale, true, true));
            }
        }, {
            "mData": "beginBalance",
            "sTitle": "金额",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "periodNetNumDr",
            "sTitle": "数量",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, numberScale, true, true));
            }
        }, {
            "mData": "periodNetDr",
            "sTitle": "金额",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "periodNetNumCr",
            "sTitle": "数量",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, numberScale, true, true));
            }
        }, {
            "mData": "periodNetCr",
            "sTitle": "金额",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "yearNetNumDr",
            "sTitle": "数量",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, numberScale, true, true));
           }
        }, {
            "mData": "yearNetDr",
            "sTitle": "金额",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "yearNetNumCr",
            "sTitle": "数量",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, numberScale, true, true));
            }
        }, {
            "mData": "yearNetCr",
            "sTitle": "金额",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "crDrStr",
            "sTitle": "方向",
            "mRender": function(data, type, full) {
                return centerAlign(data);
            }
        }, {
            "mData": "balanceQty",
            "sTitle": "数量",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, numberScale, true, true));
            }
        }, {
            "mData": "balanceUnitPrice",
            "sTitle": "单价",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, priceScale, true, true));
            }
        }, {
            "mData": "balance",
            "sTitle": "金额",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }],
        fnDrawCallback: function(oSettings) {
            $('#' + oSettings.sTableId).css("width", "100%");
        }
    });
}

// ------查询数据-----
function reGetDataTables() {
    dataTable.fnDestroy();
    initDataTables();
    closeSearchForm();
}

// ------重置表单-----
function resetForm() {
    $('#searchForm')[0].reset();
}

// obj为jquery选择器
function initTreeData(obj, index) {
    var setting = {
        view: {
            dblClickExpand: false,
            showLine: false
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        callback: {
            onClick: function(event, treeId, treeNode) {
                //console.log(treeNode)
                $$("coaCode" + index).value = treeNode.dispName;
                $("input[name=coaCode"+index+"]").val(treeNode.coaCode);
            },
            onDblClick: function(e, treeId, treeNode) {
                $$("coaCode" + index).value = treeNode.dispName;
                $("input[name=coaCode"+index+"]").val(treeNode.coaCode);
                $('#myModal').modal('hide');
            }
        }
    };
    $.fn.zTree.init($(obj), setting, coaList);
}

// 打开科目树弹窗
function openLayer(index) {
    $('#myModal').modal('show');
    initTreeData('#glCoaTree', index);
}

function printChart(){
    var data = $("#searchForm").formToObj();
    var exportUrl=ip_url+"accbook/printLedgerNum";
    $.ajax({
        url: exportUrl,
        dataType: "json",
        data: JSON.stringify(data),
        type: "post",
        async: true,
        contentType: "application/json; charset=utf-8",
        success: function(res) {
            if (res.errorCode=="0") {
                window.open("http://"+window.location.host+res.body);
            } else {
                layer.msg(res.msg,{icon:5});
            }
        },
        error: function(e) {
        	 layer.alert("系统错误!");
        }
    });
}
function exportExcel() {
    var data = $("#searchForm").formToObj();
    var exportUrl=ip_url+"accbook/exportLedgerNum";
    var temp = document.createElement("form");
    temp.action = exportUrl;
    temp.method = "POST";
    // temp.target = "_blank";
    temp.style.display = 'none';
    for (var x in data) {
        var opt = document.createElement("textarea");
        opt.name = x;
        opt.value = data[x];
        temp.appendChild(opt);
    }
    document.body.appendChild(temp);
    temp.submit();
    return temp;
}

</script>
