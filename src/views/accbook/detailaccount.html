<style type="text/css">
		table{
			table-layout:fixed;
		}
        th, td {
            word-break: keep-all;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            -moz-text-overflow: ellipsis;
        }
</style>
<div class="bw100 urel" style="padding-bottom:0">
    <div class="plr15 ov-y bgb pb15 clearfix urel" style="height:100%; padding-right:320px;">
        <div class="w_100">
            <div class="clearfix mt10">
                <form id="searchForm" class="clearfix urel search-content" style="width:800px">
                    <div class="form-group uds">
                        <label>会计期间:</label>
                        <select id="periodCode1" name="periodCode1" class="form-control w120 h28 p0 uds"></select>
                        <span>至</span>
                        <select id="periodCode2" name="periodCode2" class="form-control w120 h28 p0 uds"></select>
                        <label style="margin-left:16px">科目:</label>
                        <input type="hidden" name="coaCode1" />
                        <input type="hidden" name="crDr" id="crDr" value="1">
                        <input id="coaCode1" placeholder="选择科目" class="form-control w140 h28 uds" readonly onclick="openLayer(1)" />
                    	&nbsp;&nbsp;&nbsp;&nbsp;
	                    <button type="button" class="btn btn-wrap plr20 ufr"  onclick="exportExcel()">导出</button>	    	            	    	            	    	            
		    	        <button type="button" class="btn btn-wrap plr20 ufr"  onclick="printChart()">打印</button>
		    	        <button type="button" class="btn btn-search plr20 ufr"  onclick="reGetDataTables()">查询</button>			       		
                    </div>
                    <div class="form-group uhide">
                        <label>币&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别:</label>
                        <select id="currency" name="currency" class="form-control w140 h28 p0 uds"></select>
                    </div>
                    <div class="form-group">
                    	<!-- 
                        <input name="isShowAuxiliary" type="checkbox" value="1" class="ml20"/>
                        <span class="uds">显示辅助核算</span>
                        <input name="isOnlyShowLeaf" type="checkbox" value="1" class="ml20"/>
                        <span class="uds">只显示明细科目</span>
                         -->
                        <input name="isShowNetAndBalanceNotEqualToZero" type="checkbox" value="1" checked class="ml20" /><span class="uds">发生额为0且余额为0不显示</span>
                    </div>                    
                </form>
            </div>
            <table id="dataTable" class="table table-striped table-bordered printThis" cellspacing="0" width="100%"></table>
        </div>
        <div class="w300 uabs urt0 urel h_100" style="padding-top:40px;box-sizing:border-box;right:10px">
            <div class="ptb05 plr10 uabs ult0 w_100" style="background:#d7d7d7;top:10px">科目快速选择</div>
            <div id="glCoaTreeRight" class="ztree h_100 plr10 ov-y bac">
		                正在初始化化科目树...
            </div>
        </div>
    </div>
</div>
<!-- 科目树 -->
<div class="modal uhide" id="myModal" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog w300">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">关闭</button>
                <h4 class="modal-title" id="summaryModalLabel">请选择科目</h4>
            </div>
            <div class="modal-body clearfix p10">
                <div class="w300 plr15 ufl">
                    <div id="glCoaTree" class="ztree h400 ov-y">
                        正在初始化化科目树...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
var myDataTable;
var curSelectedTree;
initCurrencyList('currency');
initRightTreeData('#glCoaTreeRight');
getVoucherDate();
dropmenuToggle();//更多筛选
function getVoucherDate(){
    $.ajax({
        url: ip_url+"gl/period/getSelectList",
        dataType: "json",
        type: "post",
        async: true,
        contentType: "application/json; charset=utf-8",
        success: function(res) {
            coursePeriod = res.data;
            initCoaPeriod('periodCode1',res.data);initCoaPeriod('periodCode2',res.data);initDataTables(1);
        },
        error : function(e) {
            logout_login("请重新登录");
        }
    });
}

function initDataTables(type) {
    myDataTable = $("#dataTable").dataTable({
		responsive: false,
        bAutoWidth: true,
     	
        bSort: false,
        bFilter: false,
        lengthChange: false,
        iDisplayLength: 20,
        oLanguage: {
            sProcessing: "正在获取数据，请稍后...",
            sInfo : "共 _TOTAL_ 条",
            sZeroRecords: "无数据!",
            sInfoEmpty: "记录数为0",
            oPaginate: {
                "sFirst": "第一页",
                "sPrevious": "上一页",
                "sNext": "下一页",
                "sLast": "最后一页"
            }
        },
        sAjaxSource: "accbook/subsidiary/datatables",
        fnServerData: function(sSource, aDataSet, fnCallback) {
            var searchData = $("#searchForm").formToObj();
            if(type==2){
                searchData.coaCode1 = curSelectedTree.coaCode;
                searchData.crDr = curSelectedTree.crDr;
            }
            $.ajax({
                "dataType" : 'json',
                "contentType" : "application/json",
                "type" : "POST",
                "url" : sSource,
                "async" : false,
                "data": JSON.stringify(searchData),
                success : function(data){
                   	successCallback(data, aDataSet, fnCallback);
                    sessionStorage.isFlip = 0;
                   	
                    voucherData = data.data;
                    var voucherIdArray = [];
                    if(voucherData){
                        for(var i=0;i<voucherData.length;i++){
                            voucherIdArray.push(voucherData[i].id);
                        }
                    }
                    sessionStorage.voucherIdArray = JSON.stringify({data:voucherIdArray});
                   	
                },
                error : function(e) {
                    logout_login("请重新登录");
                }
            });
        },
        aoColumns: [{
            "mData": "jeDate",
            "sTitle": "日期"
        }, {
            "mData": "jeCatogery",
            "sTitle": '<center onclick="gotoVoucher(this)">凭证字号</center>',
            "mRender": function(data, type, full) {
                if(data==null||data.trim()==""){return ""}
                return '<center class="mt10 pointer" onclick="toThisVoucher(\''+full.jeHeaderId+'\')">'+data.split('-')[0] + "-" + numFormat(full.jeSeq, "0000")+'</center>';
            }
        }, {
            "mData": "summary",
            "sTitle": "<center>摘要</center>"
        }, {
            "mData": "coaCobinationName",
            "sTitle": "<center>辅助项名称</center>"
        }, {
            "mData": "accountedDr",
            "sTitle": "<center>借方金额</center>",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "accountedCr",
            "sTitle": "<center>贷方金额</center>",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }, {
            "mData": "crDr",
            "sTitle": "<center>方向</center>",
            "mRender": function(data, type, full) {
                return formatDir(data);
            }
        }, {
            "mData": "balance",
            "sTitle": "<center>余额(元)</center>",
            "mRender": function(data, type, full) {
                return rightAlign(toFormatStr(data, 2, true, true));
            }
        }],
        fnDrawCallback: function(oSettings) {
            $('#' + oSettings.sTableId).css("width", "100%");
        }
    });
}

//修改操作
function gotoVoucher(dom){
    var rowNode = dom.parentNode.parentNode.parentNode ;
    var rowData = subsidiaryTable.fnGetData(rowNode);
    var voucherId = rowData.jeHeaderId;
    sessionStorage.voucherFlag = 1;
    initVoucher(voucherId);
}

function initVoucher(id){
    $.ajax({
        dataType : 'json',
        type : "post",
        url: ip_url+"gl/voucher/getById",
        data : JSON.stringify({id:id}),
        contentType : "application/json; charset=utf-8",
        success : function(data) {
            sessionStorage.voucherFlag = 2;
            sessionStorage.curVoucherData = JSON.stringify(data.body);
            goPage("business/voucher/addVoucher.html",'查看凭证');

        },
        error : function(e) {
            logout_login("请重新登录");
        }
    });
}

// ------查询数据-----
function reGetDataTables(type) {
    myDataTable.fnDestroy();
    initDataTables(type);
    closeSearchForm();
}

// ------重置表单-----
function resetForm(){
    $('#searchForm')[0].reset();
}

// obj为jquery选择器
function initTreeData(obj,index){
    var setting = {
        view: { dblClickExpand: false, showLine: false },
        data: { simpleData: { enable: true } },
        callback: {
            onClick: function(event, treeId, treeNode) {
                $$("coaCode"+index).value = treeNode.dispName;
                $$("crDr").value = treeNode.crDr;
                $("input[name=coaCode"+index+"]").val(treeNode.coaCode);
            },
            onDblClick: function(e, treeId, treeNode) {
                $$("coaCode"+index).value = treeNode.dispName;
                $$("crDr").value = treeNode.crDr;
                $("input[name=coaCode"+index+"]").val(treeNode.coaCode);
                $('#myModal').modal('hide');
            }
        }
    };
    $.fn.zTree.init($(obj), setting,coaList);
}

// obj为jquery选择器
function initRightTreeData(obj){
    var setting = {
        view: { dblClickExpand: false, showLine: false },
        data: { simpleData: { enable: true } },
        callback: {
            onClick: function(event, treeId, treeNode) {
                curSelectedTree = treeNode;
                reGetDataTables(2);
            }
        }
    };
    $.fn.zTree.init($(obj), setting,coaList);
}


// 打开科目树弹窗
function openLayer(index) {
    $('#myModal').modal('show');
    initTreeData('#glCoaTree', index);
}

function callBackFunFtd(data) {
    var html = "";
    for (var i = 0; i < data.length; i++) {
        if (i == data.length - 1) {
            html += '<span>' + data[i] + '</span>';
            break;
        }
        html += '<span>' + data[i] + '</span><hr>';
    }
    return html;
}

function callBackFunFtdFix(data) {
    var html = "";
    for (var i = 0; i < data.length; i++) {
        var tmp = toFormatStr(data[i], 2, true, true);
        if (i == data.length - 1) {
            html += '<span>' + (tmp) + '</span>';
            break;
        }
        html += '<span>' + (tmp) + '</span><hr>';
    }
    return html;
}

function printChart(){
    var data = $("#searchForm").formToObj();
    var exportUrl=ip_url+"accbook/printSubsidiary";
    $.ajax({
        url: exportUrl,
        dataType: "json",
        data: JSON.stringify(data),
        type: "post",
        async: true,
        contentType: "application/json; charset=utf-8",
        success: function(res) {
            if (res.errorCode=="0") {
                window.open("http://"+window.location.host+res.body);
            } else {
                layer.msg(res.msg,{icon:5});
            }
        },
        error: function(e) {
        	 layer.alert("系统错误!");
        }
    });
}

function exportExcel() {
    var data = $("#searchForm").formToObj();
    var exportUrl=ip_url+"accbook/exportSubsidiary";
    var temp = document.createElement("form");
    temp.action = exportUrl;
    temp.method = "POST";
    // temp.target = "_blank";
    temp.style.display = 'none';
    for (var x in data) {
        var opt = document.createElement("textarea");
        opt.name = x;
        opt.value = data[x];
        temp.appendChild(opt);
    }
    document.body.appendChild(temp);
    temp.submit();
    return temp;
}

</script>
